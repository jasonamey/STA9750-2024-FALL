<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>mp04 – STA 9750 Fall 2024 - Jason Amey</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6a549a5e0532b7ec267537b390b66fc6.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="shortcut icon" href="images/favicon.ico">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Fall 2024 - Jason Amey</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="monte-carlo-informed-selection-of-cuny-retirement-plans" class="level1">
<h1>Monte Carlo-Informed Selection of CUNY Retirement Plans</h1>
<p><em>by Jason Amey</em></p>
<section id="table-of-contents" class="level2">
<h2 class="anchored" data-anchor-id="table-of-contents">Table of Contents</h2>
<p><a href="#i.-introduction">I. Introduction</a><br>
<a href="#ii.-registration-for-api-keys">II. Registration for API Keys</a><br>
<a href="#iii.-data-acquisition-from-fred-and-alpha-vantage">III. Data Acquisition from FRED and Alpha Vantage</a><br>
<a href="#iv.-investigation-and-visualizing-of-financial-data">IV. Investigation and Visualizing of Financial Data</a><br>
<a href="#v.-historical-comparison-of-trs-and-orp">V. Historical Comparison of TRS and ORP</a><br>
<a href="#vi.-long-term-average-analysis">VI. Long-Term Average Analysis</a><br>
<a href="#vii.-monte-carlo-analysis">VII. Monte Carlo Analysis</a><br>
</p>
<section id="i.-introduction" class="level3">
<h3 class="anchored" data-anchor-id="i.-introduction">I. Introduction</h3>
<hr>
<p>The <a href="https://www.trsnyc.org/">Teachers Retirement System (TRS)</a> is a traditional pension plan offered by <strong>CUNY</strong> that provides retirees with a fixed, defined benefit based on their years of service and final average salary <code>(FAS)</code>. Employees contribute a percentage of their paycheck to the pension fund, with rates increasing by salary tiers, and the retirement benefit is calculated using a formula based on years of service and FAS. TRS participants receive an annual inflation adjustment to their benefit tied to the <code>Consumer Price Index (CPI)</code>, capped between <code>1%</code> and <code>3%</code>. This type of plan shifts market risk to the employer; if the market languishes, <strong>CUNY</strong> covers the shortfall, while surplus returns benefit the institution.</p>
<p>The <a href="https://www.cuny.edu/wp-content/uploads/sites/4/media-assets/Benefits_Guide_Retirement_Plans-JMP.pdf">Optional Retirement Plan (ORP)</a> is a defined-contribution plan akin to a private-sector <strong>401(k)</strong>, where both the employee and employer contribute to a retirement account invested in mutual funds. Contributions vary by salary tier for employees and are fixed at <code>8%</code> for the first seven years and <code>10%</code> thereafter for the employer. Participants choose investments such as <a href="https://www.fidelity.com/mutual-funds/fidelity-fund-portfolios/freedom-funds">Fidelity Freedom Funds</a>, which adjust asset allocation based on age, gradually shifting from equities to bonds and short-term debt as retirement nears. At retirement, employees can withdraw funds at their desired rate, with unspent balances continuing to grow and being inheritable by heirs. Unlike <strong>TRS</strong>, the <strong>ORP</strong> places market risk on the employee, as the final retirement amount depends on investment performance and withdrawal strategies.</p>
<p>Performing a comparison between the <strong>Teachers Retirement System (TRS)</strong> and the <strong>Optional Retirement Plan (ORP)</strong> involves examining key aspects such as risk allocation, benefit predictability, and flexibility. Understanding these differences requires a solid grasp of economic indicators like inflation and market performance, as they directly impact the stability and returns of each plan. The choice between <strong>TRS</strong> and <strong>ORP</strong> depends on an individual’s career timeline, financial priorities, and risk tolerance.</p>
<p>The following two data sources are used to collect information for this analysis:</p>
<p>The <a href="https://fred.stlouisfed.org/">Federal Reserve Economic Data (FRED)</a> platform, maintained by the Federal Reserve Bank of St.&nbsp;Louis, is a critical resource for accessing a vast repository of financial and economic data. FRED offers over 800,000 data series<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> from various sources, including the U.S. government, international organizations, and private institutions, covering topics such as inflation, employment, GDP, interest rates, and market indices.</p>
<p><a href="https://www.alphavantage.co/">Alpha Vantage</a> offers real-time and historical financial market data through a robust API. Covering a wide range of asset classes—including stocks, ETFs, mutual funds, and commodities—along with economic indicators, <strong>Alpha Vantage</strong> serves as an extensive source for global market data.</p>
</section>
<section id="ii.-registration-for-api-keys" class="level3">
<h3 class="anchored" data-anchor-id="ii.-registration-for-api-keys">II. Registration for API Keys</h3>
<hr>
<p><strong>API</strong> Keys for <code>http</code> requests from <code>httr2</code> were secured from <a href="https://www.alphavantage.co/documentation/">Alpha Vantage</a> and <a href="https://fred.stlouisfed.org/docs/api/fred/">FRED</a>.</p>
<p>The <strong>API</strong> keys are stored as environment variables through a <code>.Renviron</code> file. This prevents hardcoding the keys directly into the project, enhancing security and privacy. By adding the lines <code>FRED_API_KEY=your_fred_api_key_here</code> and <code>ALPHA_API_KEY=your_alpha_api_key_here</code> to a <code>.Renviron</code> file, the project accesses the keys through the following syntax: <code>Sys.getenv("FRED_API_KEY")</code> and <code>Sys.getenv("ALPHA_API_KEY")</code>.</p>
<p>This method ensures sensitive information is kept secure, while also making the code portable across different environments without exposing the keys.</p>
</section>
<section id="iii.-data-acquisition-from-fred-and-alpha-vantage" class="level3">
<h3 class="anchored" data-anchor-id="iii.-data-acquisition-from-fred-and-alpha-vantage">III. Data Acquisition from FRED and Alpha Vantage</h3>
<hr>
<section id="datasets-queried-from-fred" class="level4">
<h4 class="anchored" data-anchor-id="datasets-queried-from-fred">Datasets queried from <strong>FRED</strong>:<br></h4>
<p><a href="https://fred.stlouisfed.org/series/ECIGVTWAG"><strong>Employment Cost Index: Wages and Salaries: State and Local Government: All Workers</strong></a> <code>(ECIGVTWAG)</code></p>
<p>This metric provides insight into salary trends, which directly influence contributions and the final average salary <code>(FAS)</code> for <strong>TRS</strong> participants, as well as the potential growth of <strong>ORP</strong> accounts through increased employee and employer contributions.</p>
<p><a href="https://fred.stlouisfed.org/series/CUURA101SA0"><strong>Consumer Price Index for All Urban Consumers: All Items in New York-Newark-Jersey City, NY-NJ-PA (CBSA)</strong></a> <code>(CUURA101SA0)</code></p>
<p>This is important for modeling the inflation adjustments to TRS benefits and the impact of inflation on withdrawal rates for ORP participants, ensuring the analysis accounts for regional cost-of-living trends.</p>
<p><a href="https://fred.stlouisfed.org/series/TB3MS"><strong>3-Month Treasury Bill Secondary Market Rate, Discount Basis</strong></a> <code>(TB3MS)</code></p>
<p>This measure represents returns on short-term debt, aligning with the bond and short-term debt allocations in ORP investments, particularly for older participants seeking portfolio stability.</p>
</section>
<section id="datasets-queried-from-alpha-vantage" class="level4">
<h4 class="anchored" data-anchor-id="datasets-queried-from-alpha-vantage">Datasets queried from <strong>Alpha Vantage</strong>:<br></h4>
<p><a href="https://finance.yahoo.com/quote/SPY/"><strong>SPDR S&amp;P 500 ETF Trust</strong></a> <code>(SPY)</code></p>
<p>This ETF tracks the <a href="https://www.investopedia.com/terms/s/sp500.asp"><strong>S&amp;P 500</strong></a>, providing a reliable measure of overall US equity market performance, critical for modeling the <strong>US Equity Market Total Returns</strong> portion of both <strong>TRS</strong> and <strong>ORP</strong> portfolios.</p>
<p><a href="https://finance.yahoo.com/quote/AGG/performance/"><strong>iShares Core U.S. Aggregate Bond ETF</strong></a> <code>(AGG)</code></p>
<p>As a stand-in for bond market returns, <code>AGG</code> is essential for evaluating the fixed-income allocations in <strong>ORP</strong> portfolios and understanding bond performance in stable, low-risk investments. This will be used for the <strong>Bond Market Total Returns</strong> portion of our portfolio analyis.</p>
<p><a href="https://finance.yahoo.com/quote/ACWI/"><strong>iShares MSCI ACWI ETF</strong></a> <code>(ACWI)</code></p>
<p>This global equity ETF captures international market performance representing the <strong>International Equity Market</strong> component of <strong>ORP</strong> returns.</p>
<p>This project uses the following packages: <code>scales</code>, <code>shiny</code>,<code>RColorBrewer</code>,<code>httr2</code>,<code>jsonlite</code>, <code>dplyr</code>,<code>ggplot2</code>,<code>zoo</code>,<code>tidyr</code>,<code>lubridate</code>,<code>purrr</code></p>
<details>
<summary>
&gt; show the code
</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinythemes)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Environmental variables are used to for API keys stores in .Renviorn </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">readRenviron</span>(<span class="st">"LOCATION_OF_YOUR_.Renviorn_FILE"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># FRED data </span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>FRED_API_KEY <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"FRED_API_KEY"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>FRED_BASE <span class="ot">&lt;-</span> <span class="st">"https://api.stlouisfed.org/fred/series/observations"</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for building requests with base URL and query parameters</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>build_request <span class="ot">&lt;-</span> <span class="cf">function</span>(base_url, ...) {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req_url_query</span>(...)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for sending GET requests to a REST API with response parsed as JSON</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>send_request <span class="ot">&lt;-</span> <span class="cf">function</span>(req) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req_perform</span>()</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">resp_status</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(response <span class="sc">|&gt;</span> <span class="fu">resp_body_json</span>(<span class="at">simplifyVector =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Request failed. Status code: "</span>, <span class="fu">resp_status</span>(response))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to loop through every FRED series, fetch data, and save to .csv</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Data was saved to .csv files to avoid API limits</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>fetch_fred_data <span class="ot">&lt;-</span> <span class="cf">function</span>(series_FRED, <span class="at">frequency =</span> <span class="st">"m"</span>, <span class="at">FRED_BASE =</span> FRED_BASE, <span class="at">FRED_API_KEY =</span> FRED_API_KEY, <span class="at">output_dir =</span> <span class="st">"data/mp04/"</span>){</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (fred_series <span class="cf">in</span> series_FRED) {</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build the request for FRED</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  fred_request <span class="ot">&lt;-</span> <span class="fu">build_request</span>(</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    FRED_BASE,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">series_id =</span> fred_series,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">frequency =</span> <span class="st">"m"</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> FRED_API_KEY,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">file_type =</span> <span class="st">"json"</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fetch and parse the data</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  fred_data <span class="ot">&lt;-</span> <span class="fu">send_request</span>(fred_request)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract observations as a data frame</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  fred_observations <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fred_data<span class="sc">$</span>observations)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  fred_observations <span class="ot">&lt;-</span> fred_observations <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(<span class="fu">as.character</span>(date), <span class="at">format =</span> <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a filename for the CSV and save the file</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  csv_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/mp04/"</span>, fred_series, <span class="st">"_data.csv"</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(fred_observations, csv_filename, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># FRED series to iterate over</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>series_FRED <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CES0500000003"</span>, <span class="st">"TB3MS"</span>,  <span class="st">"CPIAUCSL"</span>, <span class="st">"CUURA101SA0"</span>, )</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>series_FRED_q <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ECIGVTWAG"</span>, <span class="st">"ENUC356240010SA"</span>)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch FRED data for quarterly series </span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="fu">fetch_fred_data</span>(series_FRED_q, <span class="at">frequency =</span> <span class="st">"q"</span>, FRED_BASE, FRED_API_KEY, <span class="at">output_dir =</span> <span class="st">"data/mp04/"</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch FRED data for quarterly series </span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="fu">fetch_fred_data</span>(series_FRED, <span class="at">frequency =</span> <span class="st">"m"</span>, FRED_BASE, FRED_API_KEY, <span class="at">output_dir =</span> <span class="st">"data/mp04/"</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Alpha Vantage Data</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>ALPHA_BASE <span class="ot">&lt;-</span> <span class="st">"https://www.alphavantage.co/query"</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>ALPHA_API_KEY <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"ALPHA_API_KEY"</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to fetch and transform Alpha Vantage data</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>fetch_alpha_vantage_data <span class="ot">&lt;-</span> <span class="cf">function</span>(base_url, function_type, symbol, api_key, <span class="at">outputsize =</span> <span class="st">"full"</span>) {</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build the request</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  request <span class="ot">&lt;-</span> <span class="fu">build_request</span>(</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    base_url,</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Be careful: function is a reserved word in R</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">function</span><span class="st">`</span> <span class="ot">=</span> function_type,</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">symbol =</span> symbol,</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">apikey =</span> api_key,</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">outputsize =</span> outputsize</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Send the request and parse the response</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">send_request</span>(request)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the records and metadata</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">records =</span> response<span class="sc">$</span><span class="st">`</span><span class="at">Monthly Adjusted Time Series</span><span class="st">`</span>,</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">symbol =</span> response<span class="sc">$</span><span class="st">`</span><span class="at">Meta Data</span><span class="st">`</span><span class="sc">$</span><span class="st">`</span><span class="at">2. Symbol</span><span class="st">`</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to convert Alpha Vantage records into a data frame</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>records_to_dataframe <span class="ot">&lt;-</span> <span class="cf">function</span>(records, symbol) {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(records), <span class="cf">function</span>(date) {</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">close =</span> <span class="fu">as.numeric</span>(records[[date]][[<span class="st">"4. close"</span>]]),</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">adjusted_close =</span> <span class="fu">as.numeric</span>(records[[date]][[<span class="st">"5. adjusted close"</span>]])</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rename the 'close' column to the symbol</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df)[<span class="fu">colnames</span>(df) <span class="sc">==</span> <span class="st">"close"</span>] <span class="ot">&lt;-</span> symbol</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="co"># The ETFs sought after from Alpha Vantage</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>symbols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SPY"</span>, <span class="st">"AGG"</span>, <span class="st">"ACWI"</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (symbol <span class="cf">in</span> symbols) {</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fetch Alpha Vantage data</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  alpha_data <span class="ot">&lt;-</span> <span class="fu">fetch_alpha_vantage_data</span>(</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_url =</span> ALPHA_BASE,</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">function_type =</span> <span class="st">"TIME_SERIES_MONTHLY_ADJUSTED"</span>,</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">symbol =</span> symbol,</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> ALPHA_API_KEY</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert records to a data frame</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">records_to_dataframe</span>(alpha_data<span class="sc">$</span>records, alpha_data<span class="sc">$</span>symbol)</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date, <span class="at">format =</span> <span class="st">"%Y-%m-%d"</span>)) </span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the data frame to a CSV file for development</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  csv_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/mp04/"</span>, symbol, <span class="st">"_data.csv"</span>)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(df, <span class="at">file =</span> csv_filename, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
</section>
<section id="iv.-investigation-and-visualizing-of-financial-data" class="level3">
<h3 class="anchored" data-anchor-id="iv.-investigation-and-visualizing-of-financial-data">IV. Investigation and Visualizing of Financial Data</h3>
<hr>
<p>This graph illustrates difference in performance between <strong>SPY</strong> (S&amp;P 500 ETF) and <strong>ACWI</strong> (MSCI All Country World Index), with <strong>SPY</strong> showing much stronger growth compared to <strong>ACWI</strong>. The <strong>U.S.</strong> stock market, which has historically outperformed other global markets, especially in recent decades. The reflects the superior recent returns of U.S. stocks, driven by the strong performance of large <strong>U.S.</strong> companies, technological innovation, and economic growth, which have outpaced many international markets in terms of growth rates.</p>
<p>This kind of graph emphasizes the growth potential of <strong>U.S.</strong> stocks (<strong>SPY</strong>) compared to a more diversified global portfolio (<strong>ACWI</strong>). It shows how <strong>U.S.</strong> equities have outpaced global equities in recent years, but it doesn’t necessarily predict future performance, as market conditions can change over time.</p>
<p>It also highlights how the historical data chosen this project, which cuts off at <code>2008</code> as the earliest year available for <strong>ACWI</strong> data from <strong>Alpha Vantage</strong>, may offer a too-rosy distortion for some of the calculations in this analysis.</p>
<p><img src="images/mp-04/spy-v-acwi.jpg" class="img-fluid" style="width:80%; box-shadow: -1px 1px 2px rgba(0, 0, 0, 0.5); display: block; margin: auto;"></p>
<p><strong>SPY</strong> represents the U.S. large-cap equity market including 500 of the largest publicly traded companies in the United States while <strong>ACWI</strong> represents a broader global market, representing equities from both developed and emerging markets. Comparing their volatility provides insights into the risk profiles of U.S. equities versus the global market. This plot helps demonstrate while, despite equities’ potential for explosive growth, their volatility remains risky for older-age investors:</p>
<p><img src="images/mp-04/volatility.jpg" class="img-fluid" style="width:80%; box-shadow: -1px 1px 2px rgba(0, 0, 0, 0.5); display: block; margin: auto;"></p>
<p>What follows is the salary trend for government workers over the past 15 years:</p>
<p><img src="images/mp-04/wage-growth.jpg" class="img-fluid" style="width:80%; box-shadow: -1px 1px 2px rgba(0, 0, 0, 0.5); display: block; margin: auto;"></p>
<p>In calculating long-term averages for returns, geometric means were calculated as <a href="https://www.investopedia.com/ask/answers/06/geometricmean.asp">it’s often prefered in financial analysis</a>.</p>
<p>The <strong>arithmetic mean</strong> adds up the returns for each period and divides by the number of periods, assuming that each return is independent, not accounting for the effect of compounding. This can overestimate the actual return over time, especially when there is significant volatility.</p>
<p>The <strong>geometric mean</strong>, on the other hand, takes into account the compounding of returns over multiple periods. It calculates the average rate of return per year that would result in the same overall cumulative return over the entire period. It can be a more accurate reflection of real-world growth, as it incorporates the effect of compounded gains and losses.</p>
<p>The following calculation was used for <strong>geometric means</strong>: <span class="math display">\[
\text{Geometric Mean} = \left( \prod_{i=1}^n (1 + r_i) \right)^{\frac{1}{n}} - 1
\]</span></p>
<table class="caption-top table">
<caption>Table 1: Long-term annualized average returns for SPY, AGG, ACWI, and US Treasury.</caption>
<thead>
<tr class="header">
<th>Measure</th>
<th>Annualized Average (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SPY Returns</td>
<td>7.48%</td>
</tr>
<tr class="even">
<td>AGG Returns</td>
<td>2.99%</td>
</tr>
<tr class="odd">
<td>ACWI Returns</td>
<td>6.90%</td>
</tr>
<tr class="even">
<td>US Treasury Returns</td>
<td>1.10%</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>This datta shows the long-term annualized average returns for four different investment assets: <strong>SPY</strong> (S&amp;P 500 ETF), <strong>AGG</strong> (U.S. Aggregate Bond Index), <strong>ACWI</strong> (MSCI All Country World Index), and <strong>U.S. Treasury bonds</strong>. Over the long term, <strong>SPY</strong> has provided the highest return at <code>7.48%</code>, reflecting the strong performance of U.S. equities. <strong>ACWI</strong>, which represents global equities, generated an average return of <code>6.90%</code>, indicating that while global stocks have offered solid growth, they still lag behind the <strong>U.S.</strong> market. <strong>AGG</strong> returned <code>2.99%</code>, demonstrating the more stable but lower returns typically associated with bonds. Finally, <strong>U.S. Treasury Bonds</strong>, with a return of <code>1.10%</code>, highlight the low-growth, low-risk nature of government debt, which is often used as a safe haven in times of uncertainty. This data underscores the higher potential returns from equities compared to fixed-income investments, but also highlights the classic trade-off between risk and return.</p>
<details>
<summary>
&gt; show the code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>CPI_US <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/CPIAUCSL_data.csv"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>CPI_NY_METRO <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/CUURA101SA0_data.csv"</span>) </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>TREASURY <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/TB3MS_data.csv"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that ensures dates are in date format </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>change_to_date <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(<span class="fu">as.character</span>(date)))  </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>SPY <span class="ot">&lt;-</span> <span class="fu">change_to_date</span>(<span class="fu">read.csv</span>(<span class="st">"data/mp04/SPY_data.csv"</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>AGG <span class="ot">&lt;-</span> <span class="fu">change_to_date</span>(<span class="fu">read.csv</span>(<span class="st">"data/mp04/AGG_data.csv"</span>))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>ACWI <span class="ot">&lt;-</span> <span class="fu">change_to_date</span>(<span class="fu">read.csv</span>(<span class="st">"data/mp04/ACWI_data.csv"</span>)) </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Data only available quarterly</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>HOURLY_PRIVATE_NY_WAGES <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/ENUC356240010SA_data.csv"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>GOVERNMENT_WAGES <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/ECIGVTWAG_data.csv"</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>SPY_2008 <span class="ot">&lt;-</span> SPY <span class="sc">|&gt;</span> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2008-04-29"</span>))</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>SPY_ACWI <span class="ot">&lt;-</span> SPY_2008 <span class="sc">|&gt;</span> </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ACWI, <span class="fu">join_by</span>(date <span class="sc">==</span> date))</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>RECESSION_PERIODS <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2008-04-30"</span>, <span class="st">"2020-02-01"</span>)),</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">end =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2009-06-01"</span>, <span class="st">"2020-04-01"</span>)),</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">ymax =</span> <span class="cn">Inf</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot to demonstrate relationship between US vs. International equities</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(SPY_ACWI, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> adjusted_close.x, <span class="at">color =</span> <span class="st">"SPDR S&amp;P 500 ETF (SPY)"</span>)) <span class="sc">+</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> adjusted_close.y, <span class="at">color =</span> <span class="st">"iShares MSCI ACWI ETF (ACWI)"</span>)) <span class="sc">+</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_rect</span>(<span class="at">data =</span> RECESSION_PERIODS,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> start, <span class="at">xmax =</span> end, <span class="at">ymin =</span> ymin, <span class="at">ymax =</span> ymax),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"grey"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">limits =</span> <span class="fu">range</span>(SPY_ACWI<span class="sc">$</span>date), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Time Series of Adjusted Close Prices for SPY and ACWI"</span>,</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"SPY tracks the S&amp;P 500 Index; ACWI tracks the MSCI All-Country World Index"</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Adjusted Close Price (USD)"</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"ETF Name and Ticker"</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Alpha Vantage"</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth=</span> <span class="dv">1</span>),  </span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.25</span>), </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray95"</span>, <span class="at">size =</span> <span class="fl">0.25</span>),</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate rolling volatility (3-period rolling standard deviation)</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>rolling_window <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> SPY_ACWI <span class="sc">|&gt;</span> </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">SPY_volatility =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(adjusted_close.x, rolling_window, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">ACWI_volatility =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(adjusted_close.y, rolling_window, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape data for ggplot</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>volatility_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, SPY_volatility, ACWI_volatility) <span class="sc">|&gt;</span> </span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"Symbol"</span>, <span class="at">values_to =</span> <span class="st">"Volatility"</span>)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out rows with missing values</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>volatility_data <span class="ot">&lt;-</span> volatility_data <span class="sc">|&gt;</span> </span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Volatility))</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the volatility between SPY and ACWI</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(volatility_data, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> Volatility, <span class="at">color =</span> Symbol)) <span class="sc">+</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">limits =</span> <span class="fu">range</span>(volatility_data<span class="sc">$</span>date), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_rect</span>(<span class="at">data =</span> RECESSION_PERIODS,</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> start, <span class="at">xmax =</span> end, <span class="at">ymin =</span> ymin, <span class="at">ymax =</span> ymax),</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"grey"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Rolling Volatility: SPY vs. ACWI ETFs"</span>,</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Rolling 3-period standard deviation of adjusted close prices for SPY and ACWI ETFs"</span>,</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Rolling Volatility (Standard Deviation of Returns)"</span>,</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"ETF Ticker"</span>, </span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Alpha Vantage"</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),  </span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.25</span>), </span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray95"</span>, <span class="at">size =</span> <span class="fl">0.25</span>)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Examination of government job salary growth</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>wage_growth_public <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/ECIGVTWAG_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date), <span class="at">wage_growth_percent =</span> (value <span class="sc">-</span> <span class="fu">lag</span>(value)) <span class="sc">/</span> <span class="fu">lag</span>(value)) </span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>WAGE_GROWTH_PUBLIC <span class="ot">&lt;-</span> wage_growth_public</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for relevant time fram</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>wage_growth_2008 <span class="ot">&lt;-</span> wage_growth_public <span class="sc">|&gt;</span> </span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2008-04-01"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wage_growth_percent))</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform calculations for wage growth for salary of $45,000 since 2008</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>STARTING_SALARY <span class="ot">&lt;-</span> <span class="dv">45000</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>salary_data <span class="ot">&lt;-</span> wage_growth_2008 <span class="sc">|&gt;</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">wage_growth_percent =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(wage_growth_percent), <span class="dv">0</span>, wage_growth_percent),</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">salary =</span> STARTING_SALARY <span class="sc">*</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">lag</span>(wage_growth_percent, <span class="at">default =</span> <span class="dv">0</span>))</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Dates needed for salary interpolation</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>complete_dates <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq.Date</span>(<span class="at">from =</span> <span class="fu">min</span>(salary_data<span class="sc">$</span>date),</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">to =</span> <span class="fu">max</span>(salary_data<span class="sc">$</span>date),</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">by =</span> <span class="st">"month"</span>))</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the complete dates with existing salary data</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>salary_data_interpolated <span class="ot">&lt;-</span> salary_data <span class="sc">|&gt;</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, salary, wage_growth_percent) <span class="sc">|&gt;</span>  </span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(complete_dates, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">|&gt;</span>    </span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span>                              </span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">salary =</span> <span class="fu">na.approx</span>(salary, <span class="at">na.rm =</span> <span class="cn">FALSE</span>),   </span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">wage_growth_percent =</span> <span class="fu">na.approx</span>(wage_growth_percent, <span class="at">na.rm =</span> <span class="cn">FALSE</span>) </span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>wage_growth_percent)</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot charting the expected rise in a government job with salary of $45,000 from 2008</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(salary_data_interpolated, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> salary)) <span class="sc">+</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> RECESSION_PERIODS,</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> start, <span class="at">xmax =</span> end, <span class="at">ymin =</span> ymin, <span class="at">ymax =</span> ymax),</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"grey"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Estimated Salary Growth For State and Local Government"</span>,</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Starting salary of $45,000 with growth based on FRED Employment Cost Index"</span>,</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Salary (USD)"</span>,</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Federal Reserve Bank of St. Louis."</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fu">min</span>(salary_data<span class="sc">$</span>date), <span class="fu">max</span>(salary_data<span class="sc">$</span>date), <span class="at">by =</span> <span class="st">"2 years"</span>),</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">date_format</span>(<span class="st">"%Y"</span>),</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>),</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray95"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>),</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze returns for long-run averages</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>returns_spy <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/SPY_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),  <span class="co"># Convert date to Date format</span></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev =</span> <span class="fu">lead</span>(adjusted_close)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prev)) <span class="sc">|&gt;</span> </span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">SPY_monthly_adjusted_growth =</span> <span class="fu">round</span>((adjusted_close <span class="sc">/</span> prev) <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>returns_agg <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/AGG_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),  <span class="co"># Convert date to Date format</span></span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev =</span> <span class="fu">lead</span>(adjusted_close)</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prev)) <span class="sc">|&gt;</span> </span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">AGG_monthly_adjusted_growth =</span> <span class="fu">round</span>((adjusted_close <span class="sc">/</span> prev) <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>returns_acwi <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/ACWI_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),  <span class="co"># Convert date to Date format</span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev =</span> <span class="fu">lead</span>(adjusted_close)</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prev)) <span class="sc">|&gt;</span> </span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">ACWI_monthly_adjusted_growth =</span> <span class="fu">round</span>((adjusted_close <span class="sc">/</span> prev) <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>returns_treasury <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/TB3MS_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date)) <span class="sc">|&gt;</span> </span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2008-04-01"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(date), <span class="st">"%b-%Y"</span>), <span class="at">monthly_return =</span> <span class="fu">round</span>(value <span class="sc">/</span> <span class="dv">12</span> <span class="sc">/</span> <span class="dv">100</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(monthly_return)) <span class="sc">|&gt;</span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">treasury_monthly_return =</span> monthly_return) <span class="sc">|&gt;</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"realtime"</span>)) </span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>nyc_cpi <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/mp04/CUURA101SA0_data.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">!=</span> <span class="st">"."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(value),</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev =</span> <span class="fu">lag</span>(value),</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2008-04-01"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prev)) <span class="sc">|&gt;</span></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cpi_change =</span>  <span class="fu">round</span>((value <span class="sc">/</span> prev) <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">4</span>))</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for calculating long run average for returns</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>geometric_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data)</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(data)  <span class="co"># Number of data points</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>((<span class="fu">prod</span>(data <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> N) <span class="sc">-</span> <span class="dv">1</span>) </span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform geometric mean calculations</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>AVG_SPY_RETURNS <span class="ot">&lt;-</span> <span class="fu">geometric_mean</span>(returns_spy<span class="sc">$</span>SPY_monthly_adjusted_growth)</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>AVG_AGG_RETURNS <span class="ot">&lt;-</span> <span class="fu">geometric_mean</span>(returns_agg<span class="sc">$</span>AGG_monthly_adjusted_growth)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>AVG_ACWI_RETURNS <span class="ot">&lt;-</span> <span class="fu">geometric_mean</span>(returns_acwi<span class="sc">$</span>ACWI_monthly_adjusted_growth)</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>AVG_TREASURY_RETURNS <span class="ot">&lt;-</span> <span class="fu">geometric_mean</span>(returns_treasury<span class="sc">$</span>treasury_monthly_return)</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>AVG_NYC_CPI <span class="ot">&lt;-</span> <span class="fu">geometric_mean</span>(nyc_cpi<span class="sc">$</span>cpi_change)</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a><span class="co"># Insert long-term averages into data fram and calculate annualized averages</span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>average_returns <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>  <span class="at">Metric =</span> <span class="fu">c</span>(<span class="st">"SPY Returns"</span>, <span class="st">"AGG Returns"</span>, <span class="st">"ACWI Returns"</span>, <span class="st">"Treasury Returns"</span>, <span class="st">"NYC CPI"</span>),</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>  <span class="at">Monthly_Average =</span> <span class="fu">c</span>(</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>    AVG_SPY_RETURNS,</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>    AVG_AGG_RETURNS,</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>    AVG_ACWI_RETURNS,</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    AVG_TREASURY_RETURNS,</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>    AVG_NYC_CPI</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>  <span class="at">Annualized_Average =</span> <span class="fu">c</span>(</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> <span class="sc">*</span> AVG_SPY_RETURNS,</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> <span class="sc">*</span> AVG_AGG_RETURNS,</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> <span class="sc">*</span> AVG_ACWI_RETURNS,</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> <span class="sc">*</span> AVG_TREASURY_RETURNS,</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> <span class="sc">*</span> AVG_NYC_CPI</span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
<section id="v.-historical-comparison-of-trs-and-orp" class="level3">
<h3 class="anchored" data-anchor-id="v.-historical-comparison-of-trs-and-orp">V. Historical Comparison of TRS and ORP</h3>
<hr>
<p>What follows is a comparision between the guaranteed pension plan <strong>Teacher Retirement System (TRS)</strong>, and the <strong>Optional Retirement Program (ORP)</strong>, an investment-based retirement plan.</p>
<p>The <strong>TRS</strong> is a <strong>defined benefit</strong> (DB) plan, which means gives retirees a fixed, predictable monthly payout based on a formula that takes into account factors like years of service and salary. Theses payouts reflect a short tenure of working for only <code>~16</code> years.</p>
<p>This plot demonstrates that the data increases steadily as the starting salary rises. This type of plan is beneficial for employees who stay with the institution for an extended period, as the monthly benefit is generally based on the final salary and accumulated service years. <strong>TRS</strong> thus offers security as the pension is guaranteed and retirees are assured of a consistent income stream regardless of market performance.</p>
<p><img src="images/mp-04/trs-payments-starting-salary.jpg" class="img-fluid" style="width:80%; box-shadow: -2px 3px 3px rgba(0, 0, 0, 0.5); display: block; margin: auto;"></p>
<p>On the other hand, the <strong>ORP</strong> is a <strong>defined contribution</strong> (DC) plan, where both the employee and employer contribute to the individual’s retirement account. The total retirement benefit depends on the contributions made and the performance of the investments over time. The <strong>ORP</strong> provides more flexibility in terms of investment choices and contribution amounts, but it also introduces a level of risk, as retirees are exposed to the ups and downs of the financial markets. Looking at the data, we can see that for each starting salary, the total portfolio value under the <strong>ORP</strong> is increasing at a faster rate than the monthly payouts from <strong>TRS</strong>, reflecting the potential for higher growth in an investment-based plan. However, even though the <strong>ORP</strong> account balances grow with higher salaries, the <strong>monthly payouts</strong> (if calculated) would likely be lower than the corresponding payouts from <strong>TRS</strong>. This highlights a key difference: while the <strong>ORP</strong> offers a larger accumulated portfolio, it does not guarantee the same level of retirement income as the <strong>TRS</strong> plan. The <strong>TRS</strong> payouts, however, are predictable and increase consistently with salary, providing more stability for retirees.</p>
<table class="table-striped table-hover caption-top table">
<caption>Payouts for different CUNY retirement plans for 16 years of service</caption>
<thead>
<tr class="header">
<th>Starting Salary</th>
<th>Total Portfolio Value, OPR</th>
<th>Monthly Payout, TRS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>$15,000</td>
<td>$89,744</td>
<td>$5,689</td>
</tr>
<tr class="even">
<td>$25,000</td>
<td>$149,573</td>
<td>$9,482</td>
</tr>
<tr class="odd">
<td>$35,000</td>
<td>$210,688</td>
<td>$13,274</td>
</tr>
<tr class="even">
<td>$45,000</td>
<td>$284,711</td>
<td>$17,067</td>
</tr>
<tr class="odd">
<td>$55,000</td>
<td>$370,466</td>
<td>$20,860</td>
</tr>
<tr class="even">
<td>$65,000</td>
<td>$454,545</td>
<td>$24,652</td>
</tr>
<tr class="odd">
<td>$75,000</td>
<td>$549,199</td>
<td>$28,445</td>
</tr>
<tr class="even">
<td>$85,000</td>
<td>$630,845</td>
<td>$32,238</td>
</tr>
<tr class="odd">
<td>$95,000</td>
<td>$709,285</td>
<td>$36,030</td>
</tr>
</tbody>
</table>
<details>
<summary>
&gt; show the code
</summary>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### TRS CALCULATIONS ####</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate salary data for eventual TRS monthly benefit function</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>calculate_salary_over_time <span class="ot">&lt;-</span> <span class="cf">function</span>(starting_salary, wage_growth_file, <span class="at">start_date =</span> <span class="st">"2008-04-01"</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read and process wage growth data</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  wage_growth_public <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(wage_growth_file) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">as.Date</span>(date), </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">wage_growth_percent =</span> (value <span class="sc">-</span> <span class="fu">lag</span>(value)) <span class="sc">/</span> <span class="fu">lag</span>(value)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for relevant time frame</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  wage_growth_2008 <span class="ot">&lt;-</span> wage_growth_public <span class="sc">|&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(start_date)) <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wage_growth_percent))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform calculations for wage growth</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  salary_data <span class="ot">&lt;-</span> wage_growth_2008 <span class="sc">|&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">wage_growth_percent =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(wage_growth_percent), <span class="dv">0</span>, wage_growth_percent),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">salary =</span> starting_salary <span class="sc">*</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">lag</span>(wage_growth_percent, <span class="at">default =</span> <span class="dv">0</span>))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate complete sequence of dates</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  complete_dates <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq.Date</span>(<span class="at">from =</span> <span class="fu">min</span>(salary_data<span class="sc">$</span>date),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">to =</span> <span class="fu">max</span>(salary_data<span class="sc">$</span>date),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">by =</span> <span class="st">"month"</span>))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge complete dates and interpolate missing salary values</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  salary_data_interpolated <span class="ot">&lt;-</span> salary_data <span class="sc">|&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, salary, wage_growth_percent) <span class="sc">|&gt;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">right_join</span>(complete_dates, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">salary =</span> <span class="fu">na.approx</span>(salary, <span class="at">na.rm =</span> <span class="cn">FALSE</span>),   </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">wage_growth_percent =</span> <span class="fu">na.approx</span>(wage_growth_percent, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>wage_growth_percent)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(salary_data_interpolated)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for TRS Salary - needs salary data from 2008+</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>calculate_monthly_payout <span class="ot">&lt;-</span> <span class="cf">function</span>(salary_data){</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  last_3_salaries <span class="ot">&lt;-</span> salary_data <span class="sc">|&gt;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">"2024-07-01"</span>) <span class="sc">|</span> date <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">"2023-12-01"</span>) <span class="sc">|</span> date <span class="sc">==</span> <span class="fu">as.Date</span>(<span class="st">"2022-12-01"</span>))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  FAS <span class="ot">&lt;-</span> <span class="fu">mean</span>(last_3_salaries<span class="sc">$</span>salary)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate N, years of service</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>calculate_years_of_service <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">date_col =</span> <span class="st">"date"</span>) {</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the oldest and most recent dates</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  oldest_date <span class="ot">&lt;-</span> <span class="fu">min</span>(data[[date_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  most_recent_date <span class="ot">&lt;-</span> <span class="fu">max</span>(data[[date_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the years of service</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(<span class="fu">difftime</span>(most_recent_date, oldest_date, <span class="at">units =</span> <span class="st">"days"</span>)) <span class="sc">/</span> <span class="fl">365.25</span>)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate retirement benefit</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>calculate_retirement_benefit <span class="ot">&lt;-</span> <span class="cf">function</span>(n, fas) {</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  benefit <span class="ot">&lt;-</span> <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">20</span>) {</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.0167</span> <span class="sc">*</span> fas <span class="sc">*</span> n</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (n <span class="sc">==</span> <span class="dv">20</span>) {</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.0175</span> <span class="sc">*</span> fas <span class="sc">*</span> n</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">0.35</span> <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> (n <span class="sc">-</span> <span class="dv">20</span>)) <span class="sc">*</span> fas</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(benefit)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Set file for wage growth</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>WAGE_FILE <span class="ot">&lt;-</span> <span class="st">"data/mp04/ECIGVTWAG_data.csv"</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequence of starting salaries</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>sequence <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">15000</span>, <span class="dv">105000</span>, <span class="at">by =</span> <span class="dv">10000</span>)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty data frame to store results</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>payout_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sequence of results for TRS payouts</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (starting_salary <span class="cf">in</span> sequence) {</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>  salary_data <span class="ot">&lt;-</span> <span class="fu">calculate_salary_over_time</span>(starting_salary, WAGE_FILE)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  monthly_payout <span class="ot">&lt;-</span> <span class="fu">calculate_monthly_payout</span>(salary_data)</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>  payout_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    payout_results,</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">starting_salary =</span> starting_salary, <span class="at">monthly_payout =</span> monthly_payout)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar chart for TRS payouts</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(payout_results, <span class="fu">aes</span>(<span class="at">x =</span> starting_salary, <span class="at">y =</span> monthly_payout)) <span class="sc">+</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">15000</span>, <span class="dv">105000</span>, <span class="at">by =</span> <span class="dv">10000</span>), </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span>  <span class="co"># Dollar signs and commas for x-axis</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>(<span class="at">scale =</span> <span class="dv">1</span>)) <span class="sc">+</span>  <span class="co"># Dollar signs and commas for y-axis</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Monthly TRS Payouts by Starting Salary"</span>,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"For 16 years of service"</span>,</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Starting Salary (USD)"</span>,</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Monthly Payout (USD)"</span>,</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Generated from Wage Data"</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),  <span class="co"># Rotate x-axis labels for readability</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">10</span>)),</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.25</span>),</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="do">#### ORP CALCULATIONS ####</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>salary_data_d <span class="ot">&lt;-</span> salary_data_interpolated <span class="sc">|&gt;</span> </span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_join =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(date), <span class="st">"%b-%Y"</span>))</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>returns_agg_d <span class="ot">&lt;-</span> returns_agg <span class="sc">|&gt;</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_join =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(date), <span class="st">"%b-%Y"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date)</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>returns_spy_d <span class="ot">&lt;-</span> returns_spy <span class="sc">|&gt;</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_join =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(date), <span class="st">"%b-%Y"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date)</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>returns_acwi_d <span class="ot">&lt;-</span> returns_acwi <span class="sc">|&gt;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_join =</span> <span class="fu">format</span>(<span class="fu">as.Date</span>(date), <span class="st">"%b-%Y"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date)</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>returns_treasury_d <span class="ot">&lt;-</span> returns_treasury <span class="sc">|&gt;</span> </span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_join =</span> date) <span class="sc">|&gt;</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date)</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>combined_returns_d <span class="ot">&lt;-</span> returns_spy_d <span class="sc">|&gt;</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(returns_agg_d, <span class="at">by =</span> <span class="st">"date_join"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(returns_acwi_d, <span class="at">by =</span> <span class="st">"date_join"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(returns_treasury_d, <span class="at">by =</span> <span class="st">"date_join"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(salary_data_d, <span class="at">by =</span> <span class="st">"date_join"</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>combined_returns_d <span class="ot">&lt;-</span> combined_returns_d <span class="sc">|&gt;</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"prev"</span>),<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"adjusted"</span>), <span class="sc">-</span>date )</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>COMBINED_RETURNS <span class="ot">&lt;-</span> combined_returns_d <span class="sc">|&gt;</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>()</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>combined_csv_filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/mp04/"</span>, <span class="st">"COMBINED_SERIES.csv"</span>)</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(COMBINED_RETURNS, combined_csv_filename, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop all rows that do not exist (leaves &gt;2008 data)</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>combined_returns_2008 <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(combined_returns_d) <span class="sc">|&gt;</span> </span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(salary) <span class="sc">|&gt;</span> </span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>SPY, <span class="sc">-</span>AGG, <span class="sc">-</span>ACWI, <span class="sc">-</span>value)</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a><span class="do">### FUNCTIONS FOR CALCULATING ORP PARAMETERS </span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Employer contribution rate function</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>employer_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(years_of_service) {</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(years_of_service <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="fl">0.08</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Employee contribution rate function</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>employee_rate_calculator <span class="ot">&lt;-</span> <span class="cf">function</span>(salary) {</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>    salary <span class="sc">&lt;=</span> <span class="dv">45000</span> <span class="sc">~</span> <span class="fl">0.03</span>,</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>    salary <span class="sc">&lt;=</span> <span class="dv">55000</span> <span class="sc">~</span> <span class="fl">0.035</span>,</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>    salary <span class="sc">&lt;=</span> <span class="dv">75000</span> <span class="sc">~</span> <span class="fl">0.045</span>,</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>    salary <span class="sc">&lt;=</span> <span class="dv">100000</span> <span class="sc">~</span> <span class="fl">0.0575</span>,</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.06</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a><span class="co"># US Equities rate function</span></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>us_equities_rate_calculator <span class="ot">&lt;-</span> <span class="cf">function</span>(age) {</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span> <span class="sc">~</span> <span class="fl">0.54</span>,</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span> <span class="sc">~</span> <span class="fl">0.47</span>,</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span> <span class="sc">~</span> <span class="fl">0.34</span>,</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">75</span> <span class="sc">~</span> <span class="fl">0.19</span>,</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span>  <span class="co"># Return NA for ages outside the range</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a><span class="co"># International Equities rate function</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>international_equity_rate_calculator <span class="ot">&lt;-</span> <span class="cf">function</span>(age) {</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span> <span class="sc">~</span> <span class="fl">0.36</span>,</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span> <span class="sc">~</span> <span class="fl">0.32</span>,</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span> <span class="sc">~</span> <span class="fl">0.23</span>,</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">75</span> <span class="sc">~</span> <span class="fl">0.13</span>,</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Bonds rate function</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>bonds_rate_calculator <span class="ot">&lt;-</span> <span class="cf">function</span>(age) {</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">25</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span> <span class="sc">~</span> <span class="fl">0.10</span>,</span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span> <span class="sc">~</span> <span class="fl">0.21</span>,</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">60</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">74</span> <span class="sc">~</span> <span class="fl">0.43</span>,</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">75</span> <span class="sc">~</span> <span class="fl">0.62</span>,</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Short-Term Debt rate function</span></span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>short_term_debt_rate_calculator <span class="ot">&lt;-</span> <span class="cf">function</span>(age) {</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">75</span> <span class="sc">~</span> <span class="fl">0.06</span>,  <span class="co"># Short-term debt only applies to age 75+</span></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.00</span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add date and age to returns data </span></span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>add_date_and_age <span class="ot">&lt;-</span> <span class="cf">function</span>(data, starting_age, starting_date) {</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>  starting_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(starting_date)</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">seq.Date</span>(<span class="at">from =</span> starting_date, <span class="at">by =</span> <span class="st">"month"</span>, <span class="at">length.out =</span> <span class="fu">n</span>()),</span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add 1/12 per row</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">round</span>(starting_age <span class="sc">+</span> (<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">12</span>, <span class="dv">2</span>)</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date)</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add years of service and salary to return data</span></span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>add_service_and_salary <span class="ot">&lt;-</span> <span class="cf">function</span>(data, starting_salary, <span class="at">wage_growth =</span> AVG_NYC_CPI) {</span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>    yearly_wage_growth <span class="ot">&lt;-</span> wage_growth <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>      <span class="at">years_of_service =</span> <span class="fu">floor</span>((<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">12</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">salary =</span> starting_salary <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> yearly_wage_growth)<span class="sc">^</span>(years_of_service <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>      )  </span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to perform portfolio calculations for available data</span></span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>compute_portfolio_rates <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Determine employer contribution rate</span></span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">employer_rate =</span> <span class="fu">ifelse</span>(years_of_service <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="fl">0.08</span>, <span class="fl">0.10</span>),</span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate employee contribution rate using a custom function</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">employee_rate =</span> <span class="fu">employee_rate_calculator</span>(salary),</span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute total monthly contribution</span></span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_contribution =</span> employer_rate <span class="sc">*</span> salary <span class="sc">/</span> <span class="dv">12</span> <span class="sc">+</span> employee_rate <span class="sc">*</span> salary <span class="sc">/</span> <span class="dv">12</span>,</span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate allocation rates for different asset classes</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_rate =</span> <span class="fu">us_equities_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_rate =</span> <span class="fu">international_equity_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_rate =</span> <span class="fu">bonds_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_rate =</span> <span class="fu">short_term_debt_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>compute_portfolio_rates_retired <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate allocation rates for different asset classes</span></span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_rate =</span> <span class="fu">us_equities_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_rate =</span> <span class="fu">international_equity_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_rate =</span> <span class="fu">bonds_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_rate =</span> <span class="fu">short_term_debt_rate_calculator</span>(<span class="fu">floor</span>(age)),</span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>calculate_cumulative_portfolio <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Contributions to each asset class</span></span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_contribution =</span> total_contribution <span class="sc">*</span> us_equity_rate,</span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_contribution =</span> total_contribution <span class="sc">*</span> international_equity_rate,</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_contribution =</span> total_contribution <span class="sc">*</span> bond_rate,</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_contribution =</span> total_contribution <span class="sc">*</span> short_term_bond_rate,</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initialize cumulative values</span></span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_portfolio_value =</span> <span class="dv">0</span></span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data))) {</span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For the first row, start with contributions</span></span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>international_equity_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>bond_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>short_term_bond_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For subsequent rows, compound previous value and add contribution</span></span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>us_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>us_equity_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>international_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>international_equity_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>bond_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>short_term_bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>short_term_bond_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update total portfolio value</span></span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>total_portfolio_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>international_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>bond_value[i] <span class="sc">+</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>short_term_bond_value[i]</span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>calculate_cumulative_portfolio_working <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Contributions to each asset class</span></span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_contribution =</span> total_contribution <span class="sc">*</span> us_equity_rate,</span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_contribution =</span> total_contribution <span class="sc">*</span> international_equity_rate,</span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_contribution =</span> total_contribution <span class="sc">*</span> bond_rate,</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_contribution =</span> total_contribution <span class="sc">*</span> short_term_bond_rate,</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initialize cumulative values</span></span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_portfolio_value =</span> <span class="dv">0</span></span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate cumulative values iteratively</span></span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data))) {</span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First row: Only the contributions and returns</span></span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>international_equity_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>bond_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>short_term_bond_contribution[i] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Subsequent rows: Compound contributions and returns</span></span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>us_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>us_equity_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>international_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>international_equity_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>bond_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> (data<span class="sc">$</span>short_term_bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>short_term_bond_contribution[i]) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update total portfolio value</span></span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>total_portfolio_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>international_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>bond_value[i] <span class="sc">+</span></span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>short_term_bond_value[i]</span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>calculate_cumulative_portfolio_retired <span class="ot">&lt;-</span> <span class="cf">function</span>(data, starting_portfolio_value, <span class="at">withdrawal =</span> <span class="dv">60000</span>, <span class="at">inflation =</span> AVG_NYC_CPI ) {</span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>  yearly_withdrawal_growth <span class="ot">&lt;-</span> inflation <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distribute the starting portfolio value across asset classes</span></span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>  initial_us_equity_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fu">mean</span>(data<span class="sc">$</span>us_equity_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>  initial_international_equity_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fu">mean</span>(data<span class="sc">$</span>international_equity_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>  initial_bond_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fu">mean</span>(data<span class="sc">$</span>bond_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>  initial_short_term_bond_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fu">mean</span>(data<span class="sc">$</span>short_term_bond_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize cumulative values</span></span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_portfolio_value =</span> <span class="dv">0</span>, </span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a>      <span class="at">year =</span> <span class="fu">floor</span>((<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">12</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a>      <span class="at">withdrawal =</span> withdrawal <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> yearly_withdrawal_growth)<span class="sc">^</span>(year <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate cumulative values iteratively</span></span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data))) {</span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First row: Start with the distributed initial values and apply returns</span></span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> initial_us_equity_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> initial_international_equity_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> initial_bond_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> initial_short_term_bond_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Subsequent rows: Compound previous values and apply returns</span></span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>international_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>short_term_bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update total portfolio value</span></span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>total_portfolio_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>international_equity_value[i] <span class="sc">+</span></span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>bond_value[i] <span class="sc">+</span></span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>                                     data<span class="sc">$</span>short_term_bond_value[i] <span class="sc">-</span> </span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>                                     (data<span class="sc">$</span>withdrawal[i] <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate portfolio returns while working </span></span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>generate_portfolio_values <span class="ot">&lt;-</span> <span class="cf">function</span>(starting_salary_sequence, date_age_data) {</span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Results to return</span></span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a>  portfolio_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">salary =</span> <span class="fu">numeric</span>(),</span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_portfolio_value =</span> <span class="fu">numeric</span>()</span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (salary <span class="cf">in</span> starting_salary_sequence) {</span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>    service_salary_data <span class="ot">&lt;-</span> <span class="fu">add_service_and_salary</span>(date_age_data, salary)</span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>    portfolio_rates <span class="ot">&lt;-</span> <span class="fu">compute_portfolio_rates</span>(service_salary_data)</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>    cumulative_portfolio <span class="ot">&lt;-</span> <span class="fu">calculate_cumulative_portfolio_working</span>(portfolio_rates)</span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract portfolio value from the last row</span></span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>    last_row <span class="ot">&lt;-</span> <span class="fu">tail</span>(cumulative_portfolio, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>    total_portfolio_value <span class="ot">&lt;-</span> last_row<span class="sc">$</span>total_portfolio_value</span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>    portfolio_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>      portfolio_results,</span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">salary =</span> salary, <span class="at">total_portfolio_value =</span> total_portfolio_value)</span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(portfolio_results)</span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
<section id="vi.-long-term-average-analysis" class="level3">
<h3 class="anchored" data-anchor-id="vi.-long-term-average-analysis">VI. Long-Term Average Analysis</h3>
<hr>
<p>What follows is data illustrating how varying initial portfolio values and monthly withdrawal rates influence the longevity of a <strong>ORP</strong> retirement portfolio under historical average returns. The portfolio’s exhaustion age reflects the delicate balance between withdrawal rates, portfolio size, and market returns.</p>
<p>Because historical data was limited to the <code>mid-2000s</code>, the calculations reflect an individual who only worked for <code>~15</code> years. Starting work at age <code>45</code> and retiring at age <code>61</code>.</p>
<p>As such, for smaller portfolios like <code>$89,744</code>, even modest withdrawals of <code>$2,000</code> per month exhaust the portfolio by age <code>65</code>. With withdrawals increasing to <code>$4,000</code> or higher, the portfolio is depleted by age <code>62</code>, underscoring how quickly a smaller portfolio can be exhausted under aggressive withdrawal rates. This highlights the risks faced by retirees who may overestimate the sustainable income their portfolio can generate, particularly if returns fail to meet historical averages or if market volatility erodes capital during early retirement years.</p>
<p>The most robust portfolios, such as <code>$709,285</code>, sustain <code>$2,000</code> monthly withdrawals until age <code>117</code>, offering a safety margin well beyond typical life expectancy. Even with aggressive withdrawals of <code>$7,000</code> per month, the portfolio supports spending until age <code>70</code>.</p>
<p>The data reinforces the importance of tailoring withdrawal strategies to portfolio size and expected market conditions. Retirees with smaller portfolios must adopt conservative withdrawal rates to avoid premature depletion, while those with larger portfolios have more flexibility but still need to guard against overspending or adverse market conditions.</p>
<table class="table-striped table-hover caption-top table">
<caption>Max age until portfolio exhaustion by monthly withdrawls</caption>
<colgroup>
<col style="width: 12%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>Portfolio Value</th>
<th style="text-align: right;">Withdrawal $2,000</th>
<th style="text-align: right;">Withdrawal $3,000</th>
<th style="text-align: right;">Withdrawal $4,000</th>
<th style="text-align: right;">Withdrawal $5,000</th>
<th style="text-align: right;">Withdrawal $6,000</th>
<th style="text-align: right;">Withdrawal $7,000</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>$89,744</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">62</td>
</tr>
<tr class="even">
<td>$149,573</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">62</td>
</tr>
<tr class="odd">
<td>$210,688</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">63</td>
</tr>
<tr class="even">
<td>$284,711</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">70</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">64</td>
</tr>
<tr class="odd">
<td>$370,466</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">65</td>
</tr>
<tr class="even">
<td>$454,545</td>
<td style="text-align: right;">88</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">67</td>
</tr>
<tr class="odd">
<td>$549,199</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">68</td>
</tr>
<tr class="even">
<td>$630,845</td>
<td style="text-align: right;">106</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">69</td>
</tr>
<tr class="odd">
<td>$709,285</td>
<td style="text-align: right;">117</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">70</td>
</tr>
</tbody>
</table>
<details>
<summary>
&gt; show the code
</summary>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Above, these calculations were made : </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># avg_spy_returns &lt;- geometric_mean(returns_spy$SPY_monthly_return)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># avg_agg_returns &lt;- geometric_mean(returns_agg$AGG_monthly_return)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># avg_acwi_returns &lt;- geometric_mean(returns_acwi$ACWI_monthly_return)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># avg_treasury_returns &lt;- geometric_mean(returns_treasury$treasury_monthly_return)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>TRS_MONTHLY <span class="ot">&lt;-</span> <span class="fu">calculate_retirement_benefit</span>(N, FAS)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>OPS_PORTFOLIO <span class="ot">&lt;-</span> <span class="fu">tail</span>(portfolio_data, <span class="at">n =</span> <span class="dv">1</span>)<span class="sc">$</span>total_portfolio_value</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>STARTING_AGE <span class="ot">&lt;-</span> <span class="fu">tail</span>(portfolio_data, <span class="at">n =</span> <span class="dv">1</span>)<span class="sc">$</span>age</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>AVG_SPY_RETURNS <span class="ot">&lt;-</span> avg_spy_returns <span class="co"># Us Equities</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>AVG_AGG_RETURNS <span class="ot">&lt;-</span> avg_agg_returns <span class="co"># Bonds</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>AVG_ACWI_RETURNS <span class="ot">&lt;-</span> avg_acwi_returns <span class="co"># International Equities</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>AVG_TREASURY_RETURNS <span class="ot">&lt;-</span>avg_treasury_returns  <span class="co"># Short Term Debts</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>AVG_NYC_CPI <span class="co"># CPI</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>OPS_PORTFOLIO <span class="ot">&lt;-</span> joined_data_TRS_ORP<span class="sc">$</span><span class="st">"Total Portfolio Value, ORP"</span>[<span class="dv">1</span>]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>STARTING_AGE <span class="ot">&lt;-</span> <span class="dv">61</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>calculate_portfolio_duration <span class="ot">&lt;-</span> <span class="cf">function</span>(starting_age, portfolio_value, monthly_withdrawal, avg_us_equities, avg_international_equities, avg_bonds, avg_short_term_debt, avg_cpi) {</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  current_age <span class="ot">&lt;-</span> starting_age</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  current_portfolio <span class="ot">&lt;-</span> portfolio_value</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  month <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (current_portfolio <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine asset allocation based on age</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    allocation <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      current_age <span class="sc">&lt;</span> <span class="dv">50</span> <span class="sc">~</span> <span class="fu">c</span>(<span class="fl">0.54</span>, <span class="fl">0.36</span>, <span class="fl">0.10</span>, <span class="fl">0.00</span>),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      current_age <span class="sc">&lt;</span> <span class="dv">60</span> <span class="sc">~</span> <span class="fu">c</span>(<span class="fl">0.47</span>, <span class="fl">0.32</span>, <span class="fl">0.21</span>, <span class="fl">0.00</span>),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      current_age <span class="sc">&lt;</span> <span class="dv">75</span> <span class="sc">~</span> <span class="fu">c</span>(<span class="fl">0.34</span>, <span class="fl">0.23</span>, <span class="fl">0.43</span>, <span class="fl">0.00</span>),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">c</span>(<span class="fl">0.19</span>, <span class="fl">0.13</span>, <span class="fl">0.62</span>, <span class="fl">0.06</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate returns for this month</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    monthly_return <span class="ot">&lt;-</span> <span class="fu">sum</span>(allocation <span class="sc">*</span> <span class="fu">c</span>(avg_us_equities, avg_international_equities, avg_bonds, avg_short_term_debt))</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust for CPI</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    adjusted_withdrawal <span class="ot">&lt;-</span> monthly_withdrawal <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> avg_cpi)<span class="sc">^</span>month</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update portfolio</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    current_portfolio <span class="ot">&lt;-</span> current_portfolio <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> monthly_return) <span class="sc">-</span> adjusted_withdrawal</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update age and month</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    month <span class="ot">&lt;-</span> month <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (month <span class="sc">%%</span> <span class="dv">12</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>      current_age <span class="ot">&lt;-</span> current_age <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the number of months and ending age</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  ending_age <span class="ot">&lt;-</span> starting_age <span class="sc">+</span> <span class="fu">floor</span>(month <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ending_age)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">calculate_portfolio_duration</span>(</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">starting_age =</span> <span class="dv">61</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">portfolio_value =</span> OPS_PORTFOLIO,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">monthly_withdrawal =</span> <span class="dv">1000</span>,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_us_equities =</span> AVG_SPY_RETURNS,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_international_equities =</span> AVG_ACWI_RETURNS,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_bonds =</span> AVG_AGG_RETURNS,</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_short_term_debt =</span> AVG_TREASURY_RETURNS,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_cpi =</span> AVG_NYC_CPI</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>portfolio_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">89743.96</span>, <span class="fl">149573.26</span>, <span class="fl">210688.26</span>, <span class="fl">284710.93</span>, <span class="fl">370466.45</span>, <span class="fl">454545.09</span>, <span class="fl">549198.91</span>, <span class="fl">630844.66</span>, <span class="fl">709285.38</span>)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>monthly_withdrawals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>, <span class="dv">5000</span>,<span class="dv">6000</span>,<span class="dv">7000</span>)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (portfolio <span class="cf">in</span> portfolio_values) {</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (withdrawal <span class="cf">in</span> monthly_withdrawals) {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_portfolio_duration</span>(</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">starting_age =</span> <span class="dv">61</span>,</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">portfolio_value =</span> portfolio,</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">monthly_withdrawal =</span> withdrawal,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_us_equities =</span> AVG_SPY_RETURNS,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_international_equities =</span> AVG_ACWI_RETURNS,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_bonds =</span> AVG_AGG_RETURNS,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_short_term_debt =</span> AVG_TREASURY_RETURNS,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_cpi =</span> AVG_NYC_CPI</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(result)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>generate_portfolio_durations <span class="ot">&lt;-</span> <span class="cf">function</span>(portfolio_values, withdrawal_values, starting_age, avg_us_equities, avg_international_equities, avg_bonds, avg_short_term_debt, avg_cpi) {</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store results</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  duration_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">Portfolio_Value =</span> <span class="fu">numeric</span>(),</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">Monthly_Withdrawal =</span> <span class="fu">numeric</span>(),</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">Duration =</span> <span class="fu">numeric</span>()</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterate over portfolio values and monthly withdrawals</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (portfolio <span class="cf">in</span> portfolio_values) {</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (withdrawal <span class="cf">in</span> withdrawal_values) {</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate the portfolio duration</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>      duration <span class="ot">&lt;-</span> <span class="fu">calculate_portfolio_duration</span>(</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">starting_age =</span> starting_age,</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">portfolio_value =</span> portfolio,</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">monthly_withdrawal =</span> withdrawal,</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_us_equities =</span> AVG_SPY_RETURNS,</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_international_equities =</span> AVG_ACWI_RETURNS,</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_bonds =</span> AVG_AGG_RETURNS,</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_short_term_debt =</span> AVG_TREASURY_RETURNS,</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_cpi =</span> AVG_NYC_CPI</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the results to the data frame</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>      duration_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        duration_results,</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>          <span class="at">Portfolio_Value =</span> portfolio,</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>          <span class="at">Monthly_Withdrawal =</span> withdrawal,</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>          <span class="at">Duration =</span> duration</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(duration_results)</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
<section id="vii.-monte-carlo-analysis" class="level3">
<h3 class="anchored" data-anchor-id="vii.-monte-carlo-analysis">VII. Monte Carlo Analysis</h3>
<hr>
<p>A Shiny app was created as a robust simulation tool for understanding the financial trajectory of an <strong>ORP</strong> retirement portfolio. The app’s <strong>Monte Carlo</strong> approach introduces variability in investment returns and salary growth, reflecting the uncertainty inherent in financial markets. This variability is essential for generating a range of potential outcomes, which are visualized as individual lines representing portfolio trajectories over time. This approach anticipates both the best-case and worst-case scenarios for their retirement planning.</p>
<p>Users can modify parameters to align closely with common financial planning considerations, making the app intuitive and directly applicable to real-world decisions. The app models both wage growth and asset pricing dynamically using historical data, ensuring that returns are grounded in realistic trends. The use of <strong>Monte Carlo</strong> simulations and historical data ensures that users can assess how economic variability might impact their portfolio, equipping them with the insights needed to adjust their plans proactively.</p>
<p>The input parameters for this app are designed to capture the critical aspects of financial planning for retirement, enabling users to customize the simulation to reflect their unique circumstances and objectives. These parameters include <strong>years working</strong>, <strong>starting age</strong>, <strong>starting salary</strong>, <strong>retirement years</strong>, <strong>annual withdrawal</strong>, and the <strong>number of bootstraps</strong>.</p>
<p>Here is a running demo of the app:</p>
<iframe src="https://jasonamey.shinyapps.io/portfolio_app/" width="100%" height="1000px" style="border:none;">
</iframe>
<p>Between <code>2010</code> and <code>2024</code>, Wall Street experienced an era of unprecedented growth fueled by a combination of economic recovery, technological innovation, and accommodative monetary policy. The aftermath of the <code>2008</code> financial crisis saw central banks, particularly the Federal Reserve, implementing quantitative easing and maintaining historically low interest rates, which created a favorable environment for financial markets.</p>
<p>During this period, U.S. equities, as measured by benchmarks like the <strong>S&amp;P 500</strong>, delivered exceptional returns. As such, this basis for projection could be generating overly optimistic expectations. Long-term planning should consider more tempered assumptions, possibly aligned with historical averages rather than recent outperformance.</p>
<details>
<summary>
&gt; show the code
</summary>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsconnect)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and preprocess data</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>WAGE_GROWTH_PUBLIC <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"ECIGVTWAG_data.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date), <span class="at">wage_growth_percent =</span> (value <span class="sc">-</span> <span class="fu">lag</span>(value)) <span class="sc">/</span> <span class="fu">lag</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>COMBINED_RETURNS <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"COMBINED_SERIES.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper functions</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>compute_portfolio_rates_retired <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_rate =</span> <span class="fl">0.6</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_rate =</span> <span class="fl">0.2</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_rate =</span> <span class="fl">0.15</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_rate =</span> <span class="fl">0.05</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>calculate_cumulative_portfolio_retired <span class="ot">&lt;-</span> <span class="cf">function</span>(data, starting_portfolio_value, <span class="at">withdrawal =</span> <span class="dv">60000</span>) {</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">us_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">international_equity_value =</span> <span class="dv">0</span>,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">short_term_bond_value =</span> <span class="dv">0</span>,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_portfolio_value =</span> <span class="dv">0</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  initial_us_equity_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fl">0.6</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  initial_international_equity_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fl">0.2</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  initial_bond_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fl">0.15</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  initial_short_term_bond_value <span class="ot">&lt;-</span> starting_portfolio_value <span class="sc">*</span> <span class="fl">0.05</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data))) {</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> initial_us_equity_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> initial_international_equity_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> initial_bond_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> initial_short_term_bond_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>us_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>SPY_monthly_adjusted_growth[i])</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>international_equity_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>ACWI_monthly_adjusted_growth[i])</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>AGG_monthly_adjusted_growth[i])</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>short_term_bond_value[i <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> data<span class="sc">$</span>treasury_monthly_return[i])</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>total_portfolio_value[i] <span class="ot">&lt;-</span> data<span class="sc">$</span>us_equity_value[i] <span class="sc">+</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>international_equity_value[i] <span class="sc">+</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>bond_value[i] <span class="sc">+</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>short_term_bond_value[i] <span class="sc">-</span> withdrawal <span class="sc">/</span> <span class="dv">12</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>simulate_portfolio_working <span class="ot">&lt;-</span> <span class="cf">function</span>(num_years, starting_age, starting_salary, n_bootstrap, </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">wage_growth_public =</span> WAGE_GROWTH_PUBLIC, </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">combined_returns =</span> COMBINED_RETURNS) {</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  months <span class="ot">&lt;-</span> num_years <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  starting_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2024-12-01"</span>) <span class="sc">-</span> <span class="fu">years</span>(starting_age)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  combined_returns_no_salary <span class="ot">&lt;-</span> combined_returns <span class="sc">|&gt;</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>salary, <span class="sc">-</span>AGG, <span class="sc">-</span>SPY, <span class="sc">-</span>ACWI, <span class="sc">-</span>value) <span class="sc">|&gt;</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  bootstrap_returns <span class="ot">&lt;-</span> combined_returns_no_salary <span class="sc">|&gt;</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> months <span class="sc">*</span> n_bootstrap, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bootstrap_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_bootstrap, <span class="at">each =</span> months))</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  bootstrap_wages <span class="ot">&lt;-</span> wage_growth_public <span class="sc">|&gt;</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> months <span class="sc">*</span> n_bootstrap, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bootstrap_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_bootstrap, <span class="at">each =</span> months)) <span class="sc">|&gt;</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(bootstrap_id) <span class="sc">|&gt;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">salary =</span> starting_salary <span class="sc">*</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">lag</span>(wage_growth_percent, <span class="at">default =</span> <span class="dv">0</span>))) <span class="sc">|&gt;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>bootstrap_id, <span class="sc">-</span>wage_growth_percent)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  returns_wages <span class="ot">&lt;-</span> <span class="fu">cbind</span>(bootstrap_returns, bootstrap_wages)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  portfolio_working_calculations <span class="ot">&lt;-</span> returns_wages <span class="sc">|&gt;</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(bootstrap_id) <span class="sc">|&gt;</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">seq.Date</span>(<span class="at">from =</span> starting_date, <span class="at">by =</span> <span class="st">"month"</span>, <span class="at">length.out =</span> <span class="fu">n</span>()),</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">years_of_service =</span> <span class="fu">floor</span>((<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">12</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  portfolio_simulations <span class="ot">&lt;-</span> portfolio_working_calculations <span class="sc">|&gt;</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, bootstrap_id, <span class="at">total_portfolio_value =</span> salary) <span class="sc">|&gt;</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_from =</span> bootstrap_id,</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_from =</span> total_portfolio_value,</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_prefix =</span> <span class="st">"bootstrap_"</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(portfolio_simulations)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>simulate_retirement_portfolio <span class="ot">&lt;-</span> <span class="cf">function</span>(retirement_years, age, date, portfolio_value,  <span class="at">annual_withdrawal =</span> <span class="dv">50000</span>, <span class="at">n_bootstrap =</span> N_BOOTSTRAP, <span class="at">combined_returns_no_salary =</span> COMBINED_RETURNS) {</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the number of months</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  MONTHS <span class="ot">&lt;-</span> retirement_years <span class="sc">*</span> <span class="dv">12</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform the bootstrap simulation</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  bootstrap_returns_retired <span class="ot">&lt;-</span> combined_returns_no_salary <span class="sc">|&gt;</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> MONTHS <span class="sc">*</span> n_bootstrap, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bootstrap_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_bootstrap, <span class="at">each =</span> MONTHS)) <span class="sc">|&gt;</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(bootstrap_id) <span class="sc">|&gt;</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">seq.Date</span>(<span class="at">from =</span> <span class="fu">as.Date</span>(date), <span class="at">by =</span> <span class="st">"month"</span>, <span class="at">length.out =</span> <span class="fu">n</span>()),</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">round</span>(age <span class="sc">+</span> (<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">12</span>, <span class="dv">2</span>),</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">running_count =</span> <span class="fu">row_number</span>()</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">compute_portfolio_rates_retired</span>(.x)) <span class="sc">|&gt;</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">calculate_cumulative_portfolio_retired</span>(.x,portfolio_value, annual_withdrawal)) <span class="sc">|&gt;</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pivot the results for easier analysis</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>  portfolio_simulations_retired <span class="ot">&lt;-</span> bootstrap_returns_retired <span class="sc">|&gt;</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, bootstrap_id, total_portfolio_value) <span class="sc">|&gt;</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_from =</span> bootstrap_id,</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_from =</span> total_portfolio_value,</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_prefix =</span> <span class="st">"bootstrap_"</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(portfolio_simulations_retired)</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>working_retirement_portfolio <span class="ot">&lt;-</span> <span class="cf">function</span>(years_working, starting_age, starting_salary, </span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>                                         retirement_years, <span class="at">annual_withdrawal =</span> <span class="dv">50000</span>, <span class="at">n_bootstrap =</span> <span class="dv">10</span>, </span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">wage_growth_public =</span> WAGE_GROWTH_PUBLIC, </span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">combined_returns =</span> COMBINED_RETURNS) {</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>  working_portfolio <span class="ot">&lt;-</span> <span class="fu">simulate_portfolio_working</span>(years_working, starting_age, starting_salary, </span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>                                                  n_bootstrap, wage_growth_public, combined_returns)</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>  last_date <span class="ot">&lt;-</span> <span class="fu">tail</span>(working_portfolio<span class="sc">$</span>date, <span class="dv">1</span>)</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>  avg_portfolio_value <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">as.numeric</span>(<span class="fu">tail</span>(working_portfolio[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>  retirement_portfolio <span class="ot">&lt;-</span> <span class="fu">simulate_retirement_portfolio</span>(</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>    retirement_years, years_working <span class="sc">+</span> starting_age, last_date, avg_portfolio_value, </span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>    annual_withdrawal, n_bootstrap, combined_returns</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">rbind</span>(working_portfolio, retirement_portfolio))</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Define UI</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">titlePanel</span>(<span class="st">"Retirement Portfolio Simulation"</span>),</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarPanel</span>(</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"years_working"</span>, <span class="st">"Years Working:"</span>, <span class="at">min =</span> <span class="dv">5</span>, <span class="at">max =</span> <span class="dv">30</span>, <span class="at">value =</span> <span class="dv">20</span>, <span class="at">step =</span> <span class="dv">1</span>),</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"starting_age"</span>, <span class="st">"Starting Age:"</span>, <span class="at">min =</span> <span class="dv">25</span>, <span class="at">max =</span> <span class="dv">45</span>, <span class="at">value =</span> <span class="dv">30</span>, <span class="at">step =</span> <span class="dv">1</span>),</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>      <span class="fu">numericInput</span>(<span class="st">"starting_salary"</span>, <span class="st">"Starting Salary:"</span>, <span class="at">value =</span> <span class="dv">35000</span>, <span class="at">min =</span> <span class="dv">20000</span>, <span class="at">max =</span> <span class="dv">100000</span>, <span class="at">step =</span> <span class="dv">5000</span>),</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"retirement_years"</span>, <span class="st">"Retirement Years:"</span>, <span class="at">min =</span> <span class="dv">3</span>, <span class="at">max =</span> <span class="dv">20</span>, <span class="at">value =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="dv">1</span>),</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"annual_withdrawal"</span>, <span class="st">"Annual Withdrawal:"</span>, <span class="at">min =</span> <span class="dv">20000</span>, <span class="at">max =</span> <span class="dv">200000</span>, <span class="at">value =</span> <span class="dv">50000</span>, <span class="at">step =</span> <span class="dv">5000</span>),</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sliderInput</span>(<span class="st">"n_bootstrap"</span>, <span class="st">"Number of Bootstraps:"</span>, <span class="at">min =</span> <span class="dv">20</span>, <span class="at">max =</span> <span class="dv">200</span>, <span class="at">value =</span> <span class="dv">50</span>, <span class="at">step =</span> <span class="dv">1</span>),</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">"run_simulation"</span>, <span class="st">"Run Simulation"</span>)</span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mainPanel</span>(</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotOutput</span>(<span class="st">"simulation_plot"</span>)</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>run_simulation, {</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>    portfolio_simulation <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">working_retirement_portfolio</span>(</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>        <span class="at">years_working =</span> input<span class="sc">$</span>years_working,</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>        <span class="at">starting_age =</span> input<span class="sc">$</span>starting_age,</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>        <span class="at">starting_salary =</span> input<span class="sc">$</span>starting_salary,</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>        <span class="at">retirement_years =</span> input<span class="sc">$</span>retirement_years,</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>        <span class="at">annual_withdrawal =</span> input<span class="sc">$</span>annual_withdrawal,</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_bootstrap =</span> input<span class="sc">$</span>n_bootstrap,</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>        <span class="at">wage_growth_public =</span> WAGE_GROWTH_PUBLIC,</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>        <span class="at">combined_returns =</span> COMBINED_RETURNS</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="st">"Error during simulation: Check your inputs."</span>, <span class="at">type =</span> <span class="st">"error"</span>)</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(portfolio_simulation)) {</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>      output<span class="sc">$</span>simulation_plot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>        portfolio_simulation_long <span class="ot">&lt;-</span> portfolio_simulation <span class="sc">|&gt;</span></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"bootstrap_"</span>), <span class="at">names_to =</span> <span class="st">"bootstrap"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(portfolio_simulation_long, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> bootstrap)) <span class="sc">+</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>          <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Portfolio Simulation Over Time"</span>, <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Portfolio Value"</span>) <span class="sc">+</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>()) <span class="sc">+</span></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>          <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>          <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>simulate_retirement_portfolio</p>


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Federal Reserve Bank of St.&nbsp;Louis. FRED: Download, graph, and track 800,000 US and international time series from 110 sources. Retrieved December 2, 2024, from https://fred.stlouisfed.org<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jasonamey\.github\.io\/STA9750-2024-FALL\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>